generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id          String   @id @default(cuid())
  telegramId  String   @unique
  username    String?
  firstName   String?
  lastName    String?
  createdAt   DateTime @default(now())
  createdBy   String   // Telegram ID of the super admin who added this admin
  isActive    Boolean  @default(true)
}

model User {
  id          String   @id @default(cuid())
  telegramId  String   @unique
  username    String?
  firstName   String?
  lastName    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 抽奖活动
model Lottery {
  id              String   @id @default(cuid())
  title           String
  description     String?
  mediaType       String   @default("none") // none, image, video
  mediaUrl        String?
  
  // 参与方式
  participationMethod String @default("private") // private, keyword
  keyword         String?  // 群内关键词
  
  // 参与条件
  requireUsername Boolean  @default(false)
  requireChannels String[] // 需要加入的频道/群组 ID
  
  // 开奖设置
  drawType        String   // "time" | "count"
  drawTime        DateTime? // 定时开奖时间
  drawCount       Int?     // 人满开奖人数
  
  // 状态
  status          String   @default("active") // active, drawn, cancelled
  
  // 通知模板
  winnerNotification  String @default("恭喜 {member}！您中奖了：{goodsName}")
  creatorNotification String @default("抽奖\"{lotteryTitle}\"已开奖，中奖用户已通知。")
  groupNotification   String @default("抽奖结果已公布！中奖名单：{awardUserList}")
  
  // 关联
  createdBy       String   // 创建者 Telegram ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  drawnAt         DateTime?
  
  prizes          Prize[]
  participants    Participant[]
  winners         Winner[]
}

// 奖品
model Prize {
  id          String   @id @default(cuid())
  lotteryId   String
  lottery     Lottery  @relation(fields: [lotteryId], references: [id], onDelete: Cascade)
  name        String
  total       Int
  remaining   Int
  createdAt   DateTime @default(now())
}

// 参与者
model Participant {
  id          String   @id @default(cuid())
  lotteryId   String
  lottery     Lottery  @relation(fields: [lotteryId], references: [id], onDelete: Cascade)
  telegramId  String
  username    String?
  firstName   String?
  lastName    String?
  invitedBy   String?  // 被谁邀请的 Telegram ID
  inviteCount Int      @default(0) // 邀请了多少人
  joinedAt    DateTime @default(now())
  
  @@unique([lotteryId, telegramId])
}

// 中奖者
model Winner {
  id          String   @id @default(cuid())
  lotteryId   String
  lottery     Lottery  @relation(fields: [lotteryId], references: [id], onDelete: Cascade)
  telegramId  String
  username    String?
  firstName   String?
  prizeId     String
  prizeName   String
  notified    Boolean  @default(false)
  wonAt       DateTime @default(now())
}

// 消息模板
model Template {
  id          String   @id @default(cuid())
  type        String   // edit_success, user_join_prompt, user_join_success, winner_private, creator_private, winner_public
  content     String
  buttons     Json?    // 按钮配置 [{text: string, url: string}]
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
