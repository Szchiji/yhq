generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id          String   @id @default(cuid())
  telegramId  String   @unique
  username    String?
  firstName   String?
  lastName    String?
  createdAt   DateTime @default(now())
  createdBy   String   // Telegram ID of the super admin who added this admin
  isActive    Boolean  @default(true)
}

model User {
  id          String   @id @default(cuid())
  telegramId  String   @unique
  username    String?
  firstName   String?
  lastName    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// æŠ½å¥–æ´»åŠ¨
model Lottery {
  id              String   @id @default(cuid())
  title           String
  description     String?
  mediaType       String   @default("none") // none, image, video
  mediaUrl        String?
  
  // å‚ä¸æ–¹å¼
  participationMethod String @default("private") // private, keyword
  keyword         String?  // ç¾¤å†…å…³é”®è¯
  
  // å‚ä¸æ¡ä»¶
  requireUsername Boolean  @default(false)
  requireChannels String[] // å‘åå…¼å®¹å­—æ®µï¼Œæ–°æ•°æ®ä½¿ç”¨ channels å…³è”
  
  // å¼€å¥–è®¾ç½®
  drawType        String   // "time" | "count"
  drawTime        DateTime? // å®šæ—¶å¼€å¥–æ—¶é—´
  drawCount       Int?     // äººæ»¡å¼€å¥–äººæ•°
  
  // çŠ¶æ€
  status          String   @default("active") // active, drawn, cancelled
  
  // é€šçŸ¥æ¨¡æ¿
  winnerNotification  String @default("æ­å–œ {member}ï¼æ‚¨ä¸­å¥–äº†ï¼š{goodsName}")
  creatorNotification String @default("æŠ½å¥–\"{lotteryTitle}\"å·²å¼€å¥–ï¼Œä¸­å¥–ç”¨æˆ·å·²é€šçŸ¥ã€‚")
  groupNotification   String @default("æŠ½å¥–ç»“æœå·²å…¬å¸ƒï¼ä¸­å¥–åå•ï¼š{awardUserList}")
  
  // æ¨é€æ¶ˆæ¯æ¨¡æ¿
  publishTemplate     String @default("ğŸ‰ {lotteryTitle}\n\n{lotteryDesc}\n\nğŸ å¥–å“ï¼š{goodsList}\nğŸ‘¥ å‚ä¸æ¡ä»¶ï¼š{joinCondition}\nâ° å¼€å¥–æ¡ä»¶ï¼š{openCondition}\n\nå½“å‰å‚ä¸ï¼š{joinNum} äºº")
  
  // å…³è”
  createdBy       String   // åˆ›å»ºè€… Telegram ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  drawnAt         DateTime?
  
  channels        LotteryChannel[]
  prizes          Prize[]
  participants    Participant[]
  winners         Winner[]
  publishes       LotteryPublish[]
}

// ç¾¤/é¢‘é“ä¿¡æ¯
model LotteryChannel {
  id          String   @id @default(cuid())
  lotteryId   String
  lottery     Lottery  @relation(fields: [lotteryId], references: [id], onDelete: Cascade)
  chatId      String   // Telegram ç¾¤/é¢‘é“ ID
  title       String   // ç¾¤/é¢‘é“åç§°
  type        String   // group, supergroup, channel
  username    String?  // @usernameï¼ˆå¦‚æœæœ‰ï¼‰
  createdAt   DateTime @default(now())
  
  @@unique([lotteryId, chatId])
}

// å¥–å“
model Prize {
  id          String   @id @default(cuid())
  lotteryId   String
  lottery     Lottery  @relation(fields: [lotteryId], references: [id], onDelete: Cascade)
  name        String
  total       Int
  remaining   Int
  createdAt   DateTime @default(now())
}

// å‚ä¸è€…
model Participant {
  id          String   @id @default(cuid())
  lotteryId   String
  lottery     Lottery  @relation(fields: [lotteryId], references: [id], onDelete: Cascade)
  telegramId  String
  username    String?
  firstName   String?
  lastName    String?
  invitedBy   String?  // è¢«è°é‚€è¯·çš„ Telegram ID
  inviteCount Int      @default(0) // é‚€è¯·äº†å¤šå°‘äºº
  joinedAt    DateTime @default(now())
  
  @@unique([lotteryId, telegramId])
}

// ä¸­å¥–è€…
model Winner {
  id          String   @id @default(cuid())
  lotteryId   String
  lottery     Lottery  @relation(fields: [lotteryId], references: [id], onDelete: Cascade)
  telegramId  String
  username    String?
  firstName   String?
  prizeId     String
  prizeName   String
  notified    Boolean  @default(false)
  wonAt       DateTime @default(now())
}

// æ¨é€è®°å½•
model LotteryPublish {
  id          String   @id @default(cuid())
  lotteryId   String
  lottery     Lottery  @relation(fields: [lotteryId], references: [id], onDelete: Cascade)
  chatId      String   // æ¨é€åˆ°çš„ç¾¤/é¢‘é“ ID
  chatTitle   String?  // ç¾¤/é¢‘é“åç§°
  messageId   String?  // æ¨é€çš„æ¶ˆæ¯ IDï¼ˆç”¨äºç¼–è¾‘æ›´æ–°ï¼‰
  publishedAt DateTime @default(now())
  publishedBy String   // æ¨é€è€… Telegram ID
  
  @@index([lotteryId, chatId])
}

// æ¶ˆæ¯æ¨¡æ¿
model Template {
  id          String   @id @default(cuid())
  type        String   // edit_success, user_join_prompt, user_join_success, winner_private, creator_private, winner_public, publish
  content     String
  buttons     Json?    // æŒ‰é’®é…ç½® [{text: string, url: string}]
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
